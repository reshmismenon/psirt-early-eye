name: AI-Powered PSIRT-Early-Eye Security Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop, release/*]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  issues: write

jobs:
  psirt-early-eye-security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive analysis
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          pip install -r psirt-early-eye/requirements.txt
          
      - name: Get Changed Files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ',' | sed 's/,$//')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"
          
      - name: Run AI PSIRT-Early-Eye Orchestrator
        id: psirt-early-eye-scan
        env:
          WATSONX_API_KEY: ${{ secrets.WATSONX_API_KEY }}
          WATSONX_PROJECT_ID: ${{ secrets.WATSONX_PROJECT_ID }}
          WATSONX_URL: ${{ secrets.WATSONX_URL || 'https://us-south.ml.cloud.ibm.com' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: |
          python psirt-early-eye/scripts/orchestrator.py \
            --pr-number "$PR_NUMBER" \
            --changed-files "${{ steps.changed-files.outputs.files }}" \
            --base-branch "${{ github.base_ref }}" \
            --head-branch "${{ github.head_ref }}" \
            --repo "$REPO_NAME" \
            --output-file psirt_early_eye_report.json
            
      - name: Parse Scan Results
        id: parse-results
        run: |
          if [ -f psirt_early_eye_report.json ]; then
            CVE_SCORE=$(jq -r '.cve_score // 0' psirt_early_eye_report.json)
            STATUS=$(jq -r '.status // "UNKNOWN"' psirt_early_eye_report.json)
            SEVERITY=$(jq -r '.severity // "UNKNOWN"' psirt_early_eye_report.json)
            
            echo "cve_score=$CVE_SCORE" >> $GITHUB_OUTPUT
            echo "status=$STATUS" >> $GITHUB_OUTPUT
            echo "severity=$SEVERITY" >> $GITHUB_OUTPUT
            
            echo "CVE Score: $CVE_SCORE"
            echo "Status: $STATUS"
            echo "Severity: $SEVERITY"
          else
            echo "Error: psirt_early_eye_report.json not found"
            exit 1
          fi
          
      - name: Upload Scan Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: psirt-early-eye-scan-report
          path: psirt_early_eye_report.json
          retention-days: 90
          
      - name: Generate PR Comment
        id: generate-comment
        run: |
          python psirt-early-eye/scripts/generate_comment.py \
            --report-file psirt_early_eye_report.json \
            --output-file pr_comment.md
            
      - name: Post PR Comment
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr_comment.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
      - name: Block PR (Critical/High CVE)
        if: steps.parse-results.outputs.status == 'BLOCK'
        run: |
          echo "ðŸš¨ BLOCKING PR: Critical or High severity CVE detected (Score: ${{ steps.parse-results.outputs.cve_score }})"
          exit 1
          
      - name: Add Security Label (Medium CVE)
        if: steps.parse-results.outputs.status == 'WARN'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['security-review-required', 'medium-cve']
            });
            
      - name: Notify Security Team (Critical/High)
        if: steps.parse-results.outputs.status == 'BLOCK'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸ”’ Critical Security Alert",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ Critical CVE Detected in PR"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*PR Number:*\n#${{ github.event.pull_request.number }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*CVE Score:*\n${{ steps.parse-results.outputs.cve_score }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Severity:*\n${{ steps.parse-results.outputs.severity }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PR Link:*\n${{ github.event.pull_request.html_url }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}
          
      - name: Create Security Ticket (Critical)
        if: steps.parse-results.outputs.severity == 'CRITICAL'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SECURITY] Critical CVE in PR #${context.issue.number}`,
              body: `## Critical Security Vulnerability Detected\n\n` +
                    `**PR:** #${context.issue.number}\n` +
                    `**CVE Score:** ${{ steps.parse-results.outputs.cve_score }}\n` +
                    `**Severity:** ${{ steps.parse-results.outputs.severity }}\n\n` +
                    `Please review the PSIRT-Early-Eye scan report and take immediate action.\n\n` +
                    `[View PR](${{ github.event.pull_request.html_url }})`,
              labels: ['security', 'critical', 'cve'],
              assignees: ['security-team']
            });

# Made with Bob
